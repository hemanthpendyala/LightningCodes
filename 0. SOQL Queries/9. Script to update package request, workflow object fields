/* Script to manually submit the request in responder Org */
Savepoint sp = Database.setSavepoint();
  String requestGlobalId ='a163u0000056aCrAAI';
  try {
    ICIX_V1.GlobalUtils.setRequestTriggerAllowUpdate(true);
    ICIX_V1.GlobalUtils.setWorkflowTriggerAllowUpdate(true);
    ICIX_V1.GlobalUtils.setWorkflowStepTriggerAllowUpdate(true);

List<ICIX_V1__Workflow_Instance__c> workflowInstances= [SELECT Id, Name, ICIX_V1__Request_Global_Id__c, ICIX_V1__Request__c, ICIX_V1__Status__c
                          FROM ICIX_V1__Workflow_Instance__c
                          WHERE ICIX_V1__Request__c='a163u0000056aCrAAI'];
for(ICIX_V1__Workflow_Instance__c workflowInstance: workflowInstances ){
workflowInstance.ICIX_V1__Status__c= 'Submitted by Requestor';
}

List<ICIX_V1__Workflow_Step_Instance__c> workflowStepInstances= [SELECT Id, Name, ICIX_V1__Status__c, ICIX_V1__Workflow_Instance__c 
                              FROM ICIX_V1__Workflow_Step_Instance__c
                              WHERE ICIX_V1__Workflow_Instance__c='a1O3u000001qmWDEAY'
                              AND ICIX_V1__Step_Number__c =2];
for(ICIX_V1__Workflow_Step_Instance__c workflowStepInstance: workflowStepInstances ){
workflowStepInstance.ICIX_V1__Status__c= 'Awaiting Submit';
}
update workflowInstances;
update workflowStepInstances;
    System.debug('---Success---');
  }
  catch(exception ex){
    System.debug(LoggingLevel.ERROR, '--- Error---'+ex.getMessage());
    Database.rollback(sp);
  }

///*** Script 02: Resubmit request in responder ****///////
Savepoint sp = Database.setSavepoint();
		String requestGlobalId ='';
		try {

			GlobalUtils.setRequestTriggerAllowUpdate(true);
			GlobalUtils.setWorkflowTriggerAllowUpdate(true);
			GlobalUtils.setWorkflowStepTriggerAllowUpdate(true);

			List<String> requestGlobalIdList = new List<String>();
			requestGlobalIdList.Add(requestGlobalId);
			List<Workflow_Instance__c> workflowList = [
					SELECT Id, Name, Status__c,
							Request__c
					FROM Workflow_Instance__c
					WHERE Request__r.Global_Id__c IN :requestGlobalIdList
			];
			
//Now updating workflow step status
			List<Workflow_Step_Instance__c> workflowStepList = [
					SELECT Id, Name, Status__c
					FROM Workflow_Step_Instance__c
					WHERE Workflow_Instance__r.Request_Global_ID__c In :requestGlobalIdList
					AND Workflow_Instance__r.Status__c = 'Submitted by Requestor'
					AND Name = '3-Actor Submit To Verifier'
			];
			for (Workflow_Step_Instance__c step : workflowStepList) {
				step.Status__c = 'Awaiting Submit';
			}
			Data.modify(workflowStepList);
			// Calling Batch class and passing request id into it for resubmitting requests
			List<Request__c> requestIds = [SELECT Id FROM Request__c WHERE Global_Id__c IN :requestGlobalIdList];

			Database.executeBatch(new SendBulkRequests(requestIds), 1);
			result = 'Success';
			System.debug('---Success---');
		}
		catch(exception ex){
			result= 'Error';
			System.debug(LoggingLevel.ERROR, '--- Error---'+ex.getMessage());
			Database.rollback(sp);
		}


///***CS-1202 -  Workflow mismatch: Corrective Action stuck on 'Submitted by Responder' but Closed ****///
Savepoint sp = Database.setSavepoint();
try{
	
	ICIX_V1.GlobalUtils.setRequestTriggerAllowUpdate(true);
    ICIX_V1.GlobalUtils.setWorkflowTriggerAllowUpdate(true);
	ICIX_V1__Request__c car = [SELECT ICIX_V1__Global_ID__c,ICIX_V1__Related_Request__c,ICIX_V1__Status__c,Id,Name 
									FROM ICIX_V1__Request__c WHERE ICIX_V1__Global_ID__c = '227-DV-001674'];

	car.ICIX_V1__Status__c = 'Closed';
	System.debug(LoggingLevel.ERROR, '@@@@@ car @@@@@@: '+car);

	update car;

	List<ICIX_V1__Workflow_Instance__c> listWorkflow = [SELECT Id, Name,ICIX_V1__Status__c from ICIX_V1__Workflow_Instance__c where ICIX_V1__Request_Global_Id__c = : car.ICIX_V1__Global_ID__c];

	List<ICIX_V1__Workflow_Instance__c> listWorkflowToUpdate = new List<ICIX_V1__Workflow_Instance__c>();

	for(ICIX_V1__Workflow_Instance__c w :listWorkflow){
	    if(w.ICIX_V1__Status__c != 'Approved'){
	        w.ICIX_V1__Status__c = 'Approved';
	        listWorkflowToUpdate.add(w);
	    }
	}

	System.debug(LoggingLevel.ERROR, '@@@@@ listWorkflowToUpdate @@@@@@: '+listWorkflowToUpdate);


	if(listWorkflowToUpdate.size()>0){
	    update listWorkflowToUpdate;
	}

	ICIX_V1__Request__c carToTask = [SELECT ICIX_V1__Global_ID__c,ICIX_V1__Related_Request__c,ICIX_V1__Status__c,Id,Name 
									FROM ICIX_V1__Request__c WHERE ICIX_V1__Global_ID__c = '227-DW-001676'];

	Task taskToReopen = [SELECT ICIX_V1__Request__c,ICIX_V1__Request__R.Name, ICIX_V1__Request__R.ICIX_V1__Global_ID__c, ICIX_V1__Workflow_Status__c,
									Id,Status,CreatedDate, OwnerId, Owner.FirstName, Owner.Lastname 
										FROM Task WHERE ICIX_V1__Request__c =: carToTask.Id AND Owner.Lastname = 'Castro' AND Owner.FirstName = 'Roddy' LIMIT 1];

	taskToReopen.Status = 'Open';
	System.debug(LoggingLevel.ERROR, '@@@@@ taskToReopen @@@@@@: '+taskToReopen);
	update taskToReopen;

	System.debug(LoggingLevel.ERROR, '@@@@@ END @@@@@@: ');

}catch(exception ex){
    System.debug('@@@@@ SCRIP RESULT @@@@@@: '+ex.getMessage());
    System.debug(LoggingLevel.ERROR, '@@@@@ SCRIP RESULT @@@@@@: '+ex.getMessage());
	Database.rollback(sp);
}
